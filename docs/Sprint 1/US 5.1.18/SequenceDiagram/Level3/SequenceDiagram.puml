@startuml
title 5.1.18 - Sequence for Operation Requisition Removal (Level 3)

actor Doctor
participant SurgeryAppointmentSystem
participant PlanningModule
participant StaffController
participant StaffService
participant Repository
participant Persistence
database Database

activate Doctor

Doctor -> SurgeryAppointmentSystem: request removal of operation requisition
activate SurgeryAppointmentSystem

SurgeryAppointmentSystem -> SurgeryAppointmentSystem: display confirmation prompt

alt Doctor confirms
    Doctor -> SurgeryAppointmentSystem: confirm removal

    SurgeryAppointmentSystem -> StaffController: check if operation is scheduled
    activate StaffController

    StaffController -> StaffService: verify operation
    activate StaffService

    StaffService -> Repository: check if operation is scheduled
    activate Repository

    Repository -> Persistence: query scheduled operation
    activate Persistence

    Persistence -> Database: check operation status
    alt operation not scheduled        
        activate Database

        Database --> Persistence: operation not scheduled
        deactivate Database

        Persistence --> Repository: operation not scheduled
        deactivate Persistence

        Repository --> StaffService: operation not scheduled
        deactivate Repository

        StaffService --> StaffController: operation not scheduled
        deactivate StaffService

        StaffController -> Repository: remove operation requisition
        activate Repository

        Repository -> Persistence: remove operation requisition
        activate Persistence

        Persistence -> Database: remove requisition
        activate Database

        Database --> Persistence: requisition removed
        deactivate Database

        Persistence --> Repository: requisition removed
        deactivate Persistence

        Repository --> StaffService: requisition removed
        deactivate Repository

        StaffService --> StaffController: requisition removed
        deactivate StaffService

        StaffController -> PlanningModule: notify removal
        activate PlanningModule
        PlanningModule --> StaffController: notification sent
        deactivate PlanningModule

        StaffController --> SurgeryAppointmentSystem: operation requisition successfully removed
        deactivate StaffController
    else operation scheduled
        Repository --> StaffService: operation scheduled
        deactivate Repository
        StaffService --> StaffController: operation scheduled
        deactivate StaffService
        StaffController --> SurgeryAppointmentSystem: cannot remove requisition (scheduled)
    end
else cancellation
    SurgeryAppointmentSystem --> Doctor: removal canceled
end

deactivate SurgeryAppointmentSystem
@enduml
