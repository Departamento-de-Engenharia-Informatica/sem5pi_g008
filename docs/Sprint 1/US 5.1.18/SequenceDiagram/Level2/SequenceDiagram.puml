@startuml
title 5.1.18 - Sequence for Operation Requisition Removal (Level 2)

actor Doctor
participant SurgeryAppointmentSystem
participant PlanningModule
participant Backend
database Database

activate Doctor

Doctor -> SurgeryAppointmentSystem: request removal of operation requisition
activate SurgeryAppointmentSystem

SurgeryAppointmentSystem -> SurgeryAppointmentSystem: display confirmation prompt

alt Doctor confirms
    Doctor -> SurgeryAppointmentSystem: confirm removal

    SurgeryAppointmentSystem -> Backend: check if operation is scheduled
    deactivate SurgeryAppointmentSystem
    activate Backend
        Backend -> Database: check if operation is scheduled

    activate Database
    alt operation not scheduled
        Database -> Backend: operation not scheduled
        deactivate Database

        Backend -> Database: remove operation requisition
        activate Database
        Database --> Backend: requisition removed
        deactivate Database
        Backend --> SurgeryAppointmentSystem: requisition removed
        deactivate Backend
        activate SurgeryAppointmentSystem

        SurgeryAppointmentSystem -> PlanningModule: notify removal
        activate PlanningModule
        PlanningModule --> SurgeryAppointmentSystem: notification received
        deactivate PlanningModule
        
        SurgeryAppointmentSystem -> PlanningModule: update dependent schedules
        activate PlanningModule
        PlanningModule --> SurgeryAppointmentSystem: schedules updated
        deactivate PlanningModule

        SurgeryAppointmentSystem --> Doctor: operation requisition successfully removed
    else operation scheduled
        Database --> SurgeryAppointmentSystem: operation scheduled
        deactivate Database
        SurgeryAppointmentSystem --> Doctor: cannot remove requisition (scheduled)
    end
else cancellation
    SurgeryAppointmentSystem --> Doctor: removal canceled
end

deactivate SurgeryAppointmentSystem
@enduml
